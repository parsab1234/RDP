name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:

    # ===============================
    # Configure RDP
    # ===============================
    - name: Configure Core RDP Settings
      shell: pwsh
      run: |
        Write-Host "Configuring RDP..."

        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
          -Name "fDenyTSConnections" -Value 0 -Force

        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
          -Name "UserAuthentication" -Value 0 -Force

        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
          -Name "SecurityLayer" -Value 0 -Force

        netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null

        netsh advfirewall firewall add rule name="RDP-Tailscale" `
          dir=in action=allow protocol=TCP localport=3389

        if (Get-Service -Name TermService -ErrorAction SilentlyContinue) {
          Restart-Service -Name TermService -Force
        }

    # ===============================
    # Create RDP User
    # ===============================
    - name: Create RDP User
      shell: pwsh
      run: |
        Add-Type -AssemblyName System.Security

        $chars = @{
          Upper   = [char[]](65..90)
          Lower   = [char[]](97..122)
          Number  = [char[]](48..57)
          Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
        }

        $password = (
          ($chars.Upper   | Get-Random -Count 4) +
          ($chars.Lower   | Get-Random -Count 4) +
          ($chars.Number  | Get-Random -Count 4) +
          ($chars.Special | Get-Random -Count 4)
        ) | Sort-Object { Get-Random } | -join ''

        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
        }

        Add-LocalGroupMember -Group "Administrators" -Member "RDP"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    # ===============================
    # Install Tailscale
    # ===============================
    - name: Install Tailscale
      shell: pwsh
      run: |
        $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $path = "$env:TEMP\tailscale.msi"

        Invoke-WebRequest $url -OutFile $path
        Start-Process msiexec.exe -ArgumentList "/i", "`"$path`"", "/quiet", "/norestart" -Wait
        Remove-Item $path -Force

    # ===============================
    # Connect to Tailscale
    # ===============================
    - name: Establish Tailscale Connection
      shell: pwsh
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
          --hostname=gh-runner-$env:GITHUB_RUN_ID

        $ip = $null
        for ($i=0; $i -lt 10; $i++) {
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if ($ip) { break }
          Start-Sleep 5
        }

        if (-not $ip) {
          Write-Error "Tailscale IP not assigned"
          exit 1
        }

        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

    # ===============================
    # Verify RDP
    # ===============================
    - name: Verify RDP Access
      shell: pwsh
      run: |
        Write-Host "Testing RDP on $env:TAILSCALE_IP"

        $test = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
        if (-not $test.TcpTestSucceeded) {
          Write-Error "RDP port not reachable"
          exit 1
        }

        Write-Host "RDP is reachable"

    # ===============================
    # Keep Alive
    # ===============================
    - name: Maintain Connection
      shell: pwsh
      run: |
        Write-Host "================================="
        Write-Host " RDP READY"
        Write-Host " IP: $env:TAILSCALE_IP"
        Write-Host " USER: RDP"
        Write-Host " PASSWORD: (stored in env)"
        Write-Host "================================="

        while ($true) {
          Write-Host "[$(Get-Date)] RDP alive..."
          Start-Sleep 300
        }
